<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brookline Town Meeting Voting Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab:hover {
            color: #333;
        }

        .tab.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
            min-width: 300px;
        }

        select:hover {
            border-color: #3498db;
        }

        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .results {
            display: grid;
            grid-template-columns: repeat(4, minmax(300px, 1fr));
            gap: 20px;
        }

        .vote-results-container {
            width: 100%;
        }

        .vote-column {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }

        .vote-column h3 {
            font-size: 18px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
        }

        .article-description {
            background-color: #e8f4f8;
            border: 1px solid #b8e0e8;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.4;
        }

        .article-description h4 {
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 14px;
            font-weight: 600;
        }

        .article-item-with-desc {
            margin-bottom: 12px;
        }

        .article-title {
            padding: 8px 12px;
            background-color: white;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid #e9ecef;
            font-weight: 600;
            color: #2c3e50;
        }

        .article-desc {
            padding: 6px 12px;
            margin-top: 4px;
            margin-left: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-style: italic;
            border-left: 3px solid #dee2e6;
        }

        .vote-column.yes h3 {
            background-color: #d4edda;
            color: #155724;
        }

        .vote-column.no h3 {
            background-color: #f8d7da;
            color: #721c24;
        }

        .vote-column.abstain h3 {
            background-color: #fff3cd;
            color: #856404;
        }

        .vote-column.novote h3 {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .member-list,
        .article-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .member-item,
        .article-item {
            padding: 8px 12px;
            margin-bottom: 4px;
            background-color: white;
            border-radius: 6px;
            font-size: 14px;
            line-height: 1.4;
            border: 1px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .member-item:hover,
        .article-item:hover {
            background-color: #f1f3f5;
            transform: translateX(2px);
        }

        .precinct-label {
            font-weight: 600;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Brookline Town Meeting Voting Analysis</h1>
        <p class="subtitle">Use the dropdown below to select a Town Meeting session.</p>

        <div class="loading" id="loading">
            Loading voting data...
        </div>

        <div id="main-content" style="display: none;">

            <!-- Spreadsheet selector -->
            <div class="controls" style="margin-bottom: 20px;">
                <div class="control-group">
                    <label for="spreadsheet-select">Select Spreadsheet:</label>
                    <select id="spreadsheet-select">
                        <option value="May%202025%20Votes.xlsx">May 2025 Votes (45 votes)</option>
                        <option value="November%202025%20Votes.xlsx" selected>November 2025 Votes (19 votes)</option>
                    </select>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('by-vote')">View by Vote</button>
                <button class="tab" onclick="switchTab('by-member')">View by Member</button>
            </div>

            <div id="by-vote" class="tab-content active">
                <div class="controls">
                    <div class="control-group">
                        <label for="vote-select">Select Vote:</label>
                        <select id="vote-select"></select>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sort-by-name-vote" onchange="updateVoteResults()">
                            <label for="sort-by-name-vote">Sort by last name only</label>
                        </div>
                    </div>
                </div>
                <div id="vote-results" class="vote-results-container"></div>
            </div>

            <div id="by-member" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label for="member-select">Select Member:</label>
                        <select id="member-select"></select>
                        <div class="checkbox-group">
                            <input type="checkbox" id="sort-by-precinct-member" onchange="populateMemberDropdown()">
                            <label for="sort-by-precinct-member">Sort by precinct, then name</label>
                        </div>
                    </div>
                </div>
                <div id="member-results" class="results"></div>
            </div>
        </div>
    </div>


    <script>
        // Configuration for spreadsheet layout
        const TITLE_ROW_INDEX = 2;       // zero-based: Excel row 3
        const DESCRIPTION_ROW_INDEX = 3; // zero-based: Excel row 4
        const HEADER_ROW_INDEX = 4;      // zero-based: Excel row 5
        const FIRST_DATA_ROW_INDEX = 5;  // zero-based: Excel row 6

        const PRECINCT_COL_INDEX = 0;    // column A
        const NAME_COL_INDEX = 1;        // column B
        const FIRST_VOTE_COL_INDEX = 2;  // column C

        // Generous upper bound; will be reset and clamped per sheet
        let LAST_VOTE_COL_INDEX = 60;

        // Global variables
        let votingData = null;
        let votes = [];
        let members = [];

        const loadingEl = document.getElementById('loading');
        const mainContentEl = document.getElementById('main-content');

        // Build the URL for the currently selected spreadsheet
        function getSelectedSpreadsheetURL() {
            const select = document.getElementById('spreadsheet-select');
            const file = select ? select.value : 'November%202025%20Votes.xlsx';
            return `https://raw.githubusercontent.com/millxing/TM/main/${file}`;
        }

        function precinctSortValue(p) {
            // numeric precincts first, then AL/others
            const n = parseInt(p, 10);
            if (!isNaN(n)) return n;
            if (String(p).toUpperCase() === 'AL') return 999;
            return 998; // any other non-numeric precincts
        }

        function normalizeVote(raw) {
            let v = (raw == null ? '' : String(raw)).trim().toUpperCase();
            if (!v) return 'NoVote';
            if (v === 'Y') return 'YES';
            if (v === 'N') return 'NO';
            if (v === 'A') return 'ABSTAIN';
            if (v === 'YES' || v === 'NO' || v === 'ABSTAIN') return v;
            return 'NoVote';
        }

        async function loadVotingDataFromExcel() {
            try {
                // Reset the upper bound each time we load a new sheet
                LAST_VOTE_COL_INDEX = 60;

                if (loadingEl) loadingEl.textContent = 'Loading voting data from spreadsheet...';

                const response = await fetch(getSelectedSpreadsheetURL());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];

                // Get raw rows as array-of-arrays
                const rows = XLSX.utils.sheet_to_json(sheet, {
                    header: 1,
                    blankrows: false,
                    defval: ''
                });

                if (!rows || rows.length <= HEADER_ROW_INDEX) {
                    throw new Error('Spreadsheet does not contain expected header rows.');
                }

                const titleRow = rows[TITLE_ROW_INDEX] || [];
                const descRow = rows[DESCRIPTION_ROW_INDEX] || [];
                const headerRow = rows[HEADER_ROW_INDEX] || [];

                // Clamp LAST_VOTE_COL_INDEX to this sheet's header width
                const maxCol = headerRow.length - 1;
                if (maxCol > FIRST_VOTE_COL_INDEX && LAST_VOTE_COL_INDEX > maxCol) {
                    LAST_VOTE_COL_INDEX = maxCol;
                }

                // Build votes list
                votes = [];
                for (let col = FIRST_VOTE_COL_INDEX; col <= LAST_VOTE_COL_INDEX; col++) {
                    const title = String(titleRow[col] || headerRow[col] || '').trim();
                    if (!title) continue; // skip totally blank columns
                    const description = String(descRow[col] || '').trim();
                    votes.push({
                        colIndex: col,
                        title: title,
                        description: description
                    });
                }

                // Build members and votingData
                members = [];
                votingData = {};

                for (let r = FIRST_DATA_ROW_INDEX; r < rows.length; r++) {
                    const row = rows[r] || [];
                    const nameRaw = row[NAME_COL_INDEX];
                    const precinctRaw = row[PRECINCT_COL_INDEX];

                    const name = String(nameRaw || '').trim();
                    const precinct = String(precinctRaw || '').trim();
                    const upperName = name.toUpperCase();
                    const upperPrecinct = precinct.toUpperCase();

                    // Skip blank rows
                    if (!name && !precinct) continue;

                    // Filter out summary rows like YES/NO/ABSTAIN/NO VOTE, TOTAL, etc.
                    const disallowedNames = ['YES', 'NO', 'ABSTAIN', 'NO VOTE', 'TOTAL', 'ARTICLE', 'MOTION'];
                    if (!name || disallowedNames.includes(upperName)) continue;

                    // Require a valid precinct: numeric or 'AL'
                    const precinctNum = parseInt(precinct, 10);
                    const isNumericPrecinct = !isNaN(precinctNum);
                    const isAL = upperPrecinct === 'AL';
                    if (!isNumericPrecinct && !isAL) continue;

                    const memberKey = `${name} (Precinct ${precinct})`;

                    members.push({
                        name,
                        precinct,
                        key: memberKey
                    });

                    const voteMap = {};
                    votes.forEach(v => {
                        const rawCell = row[v.colIndex];
                        voteMap[v.title] = normalizeVote(rawCell);
                    });

                    votingData[memberKey] = {
                        precinct,
                        votes: voteMap
                    };
                }

                initializeApp();
            } catch (err) {
                console.error(err);
                if (loadingEl) loadingEl.textContent = 'Error loading spreadsheet: ' + err.message;
            }
        }

        function initializeApp() {
            // Sort members by precinct then name
            members.sort((a, b) => {
                const pa = precinctSortValue(a.precinct);
                const pb = precinctSortValue(b.precinct);
                if (pa !== pb) return pa - pb;
                return a.name.localeCompare(b.name);
            });

            populateDropdowns();

            if (loadingEl) loadingEl.style.display = 'none';
            if (mainContentEl) mainContentEl.style.display = 'block';

            if (votes.length > 0) {
                const voteSelect = document.getElementById('vote-select');
                if (voteSelect) {
                    voteSelect.value = votes[0].title;
                }
                updateVoteResults();
            }

            const memberSelect = document.getElementById('member-select');
            if (memberSelect && memberSelect.value && votingData[memberSelect.value]) {
                updateMemberResults();
            }
        }

        function populateMemberDropdown() {
            const memberSelect = document.getElementById('member-select');
            if (!memberSelect) return;

            const sortByPrecinct = document.getElementById('sort-by-precinct-member') ?
                document.getElementById('sort-by-precinct-member').checked : false;
            const currentValue = memberSelect.value;

            let sortedMembers = [...members];

            sortedMembers.sort((a, b) => {
                if (sortByPrecinct) {
                    const pa = precinctSortValue(a.precinct);
                    const pb = precinctSortValue(b.precinct);
                    if (pa !== pb) return pa - pb;
                }
                return a.name.localeCompare(b.name);
            });

            memberSelect.innerHTML = '';
            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.key;
                option.textContent = member.key;
                memberSelect.appendChild(option);
            });

            if (currentValue && Array.from(memberSelect.options).some(opt => opt.value === currentValue)) {
                memberSelect.value = currentValue;
            } else if (memberSelect.options.length > 0) {
                memberSelect.value = memberSelect.options[0].value;
            }
        }

        function populateDropdowns() {
            const voteSelect = document.getElementById('vote-select');
            if (!voteSelect) return;

            voteSelect.innerHTML = '';
            votes.forEach(vote => {
                const option = document.createElement('option');
                option.value = vote.title;
                option.textContent = vote.title;
                voteSelect.appendChild(option);
            });

            populateMemberDropdown();

            // Attach listeners (if reattached, it's still safe)
            voteSelect.addEventListener('change', updateVoteResults);
            const memberSelect = document.getElementById('member-select');
            if (memberSelect) {
                memberSelect.addEventListener('change', updateMemberResults);
            }
        }

        function updateVoteResults() {
            const selectedVote = document.getElementById('vote-select').value;
            const sortByNameOnly = document.getElementById('sort-by-name-vote').checked;
            const resultsDiv = document.getElementById('vote-results');

            const selectedVoteDetails = votes.find(v => v.title === selectedVote);
            const description = selectedVoteDetails ? selectedVoteDetails.description : '';

            const voteGroups = {
                YES: [],
                NO: [],
                ABSTAIN: [],
                NoVote: []
            };

            members.forEach(member => {
                const voteVal = votingData[member.key].votes[selectedVote];
                const normalizedVote = voteVal ? voteVal.toUpperCase() : 'NOVOTE';

                if (normalizedVote === 'YES') {
                    voteGroups.YES.push(member);
                } else if (normalizedVote === 'NO') {
                    voteGroups.NO.push(member);
                } else if (normalizedVote === 'ABSTAIN') {
                    voteGroups.ABSTAIN.push(member);
                } else {
                    voteGroups.NoVote.push(member);
                }
            });

            Object.keys(voteGroups).forEach(voteType => {
                voteGroups[voteType].sort((a, b) => {
                    if (sortByNameOnly) {
                        return a.name.localeCompare(b.name);
                    } else {
                        const pa = precinctSortValue(a.precinct);
                        const pb = precinctSortValue(b.precinct);
                        if (pa !== pb) return pa - pb;
                        return a.name.localeCompare(b.name);
                    }
                });
            });

            const totalVotes = voteGroups.YES.length + voteGroups.NO.length;
            const percentages = {
                YES: totalVotes > 0 ? ((voteGroups.YES.length / totalVotes) * 100).toFixed(1) : '0.0',
                NO: totalVotes > 0 ? ((voteGroups.NO.length / totalVotes) * 100).toFixed(1) : '0.0'
            };

            let html = '';

            if (description) {
                html += `
                    <div class="article-description">
                        <h4>Article Description</h4>
                        <div>${description}</div>
                    </div>
                `;
            }

            const formatPrecinctLabel = (p) => {
                const up = String(p).toUpperCase();
                if (up === 'AL') return 'AL';
                return 'P' + p;
            };

            html += `
                <div class="results">
                    <div class="vote-column yes">
                        <h3>Yes (${voteGroups.YES.length}, ${percentages.YES}%)</h3>
                        <div class="member-list">
                            ${voteGroups.YES.map(m => `
                                <div class="member-item">
                                    <span class="precinct-label">${formatPrecinctLabel(m.precinct)}:</span> ${m.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="vote-column no">
                        <h3>No (${voteGroups.NO.length}, ${percentages.NO}%)</h3>
                        <div class="member-list">
                            ${voteGroups.NO.map(m => `
                                <div class="member-item">
                                    <span class="precinct-label">${formatPrecinctLabel(m.precinct)}:</span> ${m.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="vote-column abstain">
                        <h3>Abstain (${voteGroups.ABSTAIN.length})</h3>
                        <div class="member-list">
                            ${voteGroups.ABSTAIN.map(m => `
                                <div class="member-item">
                                    <span class="precinct-label">${formatPrecinctLabel(m.precinct)}:</span> ${m.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="vote-column novote">
                        <h3>No Vote (${voteGroups.NoVote.length})</h3>
                        <div class="member-list">
                            ${voteGroups.NoVote.map(m => `
                                <div class="member-item">
                                    <span class="precinct-label">${formatPrecinctLabel(m.precinct)}:</span> ${m.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            resultsDiv.innerHTML = html;
        }

        function updateMemberResults() {
            const selectedMember = document.getElementById('member-select').value;
            const resultsDiv = document.getElementById('member-results');

            if (!selectedMember || !votingData[selectedMember]) return;

            const memberVotes = votingData[selectedMember].votes;

            const voteGroups = {
                YES: [],
                NO: [],
                ABSTAIN: [],
                NoVote: []
            };

            votes.forEach(vote => {
                const voteValue = memberVotes[vote.title];
                const normalizedVote = voteValue ? voteValue.toUpperCase() : 'NOVOTE';

                const voteWithDesc = {
                    title: vote.title,
                    description: vote.description
                };

                if (normalizedVote === 'YES') {
                    voteGroups.YES.push(voteWithDesc);
                } else if (normalizedVote === 'NO') {
                    voteGroups.NO.push(voteWithDesc);
                } else if (normalizedVote === 'ABSTAIN') {
                    voteGroups.ABSTAIN.push(voteWithDesc);
                } else {
                    voteGroups.NoVote.push(voteWithDesc);
                }
            });

            const sortByArticle = (a, b) => {
                const aIsTerminate = a.title.toLowerCase().includes('terminate debate');
                const bIsTerminate = b.title.toLowerCase().includes('terminate debate');

                if (aIsTerminate && !bIsTerminate) return 1;
                if (!aIsTerminate && bIsTerminate) return -1;

                const aMatch = a.title.match(/Article (\d+)/i);
                const bMatch = b.title.match(/Article (\d+)/i);
                if (aMatch && bMatch) {
                    return parseInt(aMatch[1]) - parseInt(bMatch[1]);
                }
                return a.title.localeCompare(b.title);
            };

            Object.keys(voteGroups).forEach(voteType => {
                voteGroups[voteType].sort(sortByArticle);
            });

            const total = votes.length;
            const percentages = {
                YES: total > 0 ? ((voteGroups.YES.length / total) * 100).toFixed(1) : '0.0',
                NO: total > 0 ? ((voteGroups.NO.length / total) * 100).toFixed(1) : '0.0',
                ABSTAIN: total > 0 ? ((voteGroups.ABSTAIN.length / total) * 100).toFixed(1) : '0.0',
                NoVote: total > 0 ? ((voteGroups.NoVote.length / total) * 100).toFixed(1) : '0.0'
            };

            resultsDiv.innerHTML = `
                <div class="vote-column yes">
                    <h3>Yes (${voteGroups.YES.length}, ${percentages.YES}%)</h3>
                    <div class="article-list">
                        ${voteGroups.YES.map(v => `
                            <div class="article-item-with-desc">
                                <div class="article-title">${v.title}</div>
                                ${v.description ? `<div class="article-desc">${v.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="vote-column no">
                    <h3>No (${voteGroups.NO.length}, ${percentages.NO}%)</h3>
                    <div class="article-list">
                        ${voteGroups.NO.map(v => `
                            <div class="article-item-with-desc">
                                <div class="article-title">${v.title}</div>
                                ${v.description ? `<div class="article-desc">${v.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="vote-column abstain">
                    <h3>Abstain (${voteGroups.ABSTAIN.length}, ${percentages.ABSTAIN}%)</h3>
                    <div class="article-list">
                        ${voteGroups.ABSTAIN.map(v => `
                            <div class="article-item-with-desc">
                                <div class="article-title">${v.title}</div>
                                ${v.description ? `<div class="article-desc">${v.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="vote-column novote">
                    <h3>No Vote (${voteGroups.NoVote.length}, ${percentages.NoVote}%)</h3>
                    <div class="article-list">
                        ${voteGroups.NoVote.map(v => `
                            <div class="article-item-with-desc">
                                <div class="article-title">${v.title}</div>
                                ${v.description ? `<div class="article-desc">${v.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'by-member' && members.length > 0) {
                updateMemberResults();
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const spreadsheetSelect = document.getElementById('spreadsheet-select');
            if (spreadsheetSelect) {
                spreadsheetSelect.addEventListener('change', () => {
                    if (loadingEl) {
                        loadingEl.style.display = 'block';
                        loadingEl.textContent = 'Loading voting data...';
                    }
                    if (mainContentEl) {
                        mainContentEl.style.display = 'none';
                    }

                    // Clear previous data and reload
                    votingData = null;
                    votes = [];
                    members = [];

                    loadVotingDataFromExcel();
                });
            }

            // Initial load (uses whichever spreadsheet is selected by default)
            loadVotingDataFromExcel();
        });
    </script>

</body>

</html>